<?xml version="1.0" encoding="UTF-8"?>
<mule xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:munit="http://www.mulesoft.org/schema/mule/munit"
	xmlns:munit-tools="http://www.mulesoft.org/schema/mule/munit-tools"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xsi:schemaLocation="
		http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
		http://www.mulesoft.org/schema/mule/munit http://www.mulesoft.org/schema/mule/munit/current/mule-munit.xsd
		http://www.mulesoft.org/schema/mule/munit-tools http://www.mulesoft.org/schema/mule/munit-tools/current/mule-munit-tools.xsd">

	<munit:config name="sf-to-db-sync-test-suite.xml"/>
	<global-property doc:name="Global Property" name="env" value="test" />

	<!-- ============================================== -->
	<!-- Test 1: Happy Path - SF to DB Sync            -->
	<!-- Tests syncSalesforceToDb sub-flow             -->
	<!-- Only syncs SF contacts NOT in DB (by email)   -->
	<!-- ============================================== -->
	<munit:test name="sf-to-db-happy-path-test" description="Test successful sync of SF-only contacts to Database">

		<munit:behavior>
			<!-- Mock Database Select returning empty (no existing customers) -->
			<munit-tools:mock-when doc:name="Mock DB Select" processor="db:select">
				<munit-tools:then-return>
					<munit-tools:payload value="#[[]]"/>
				</munit-tools:then-return>
			</munit-tools:mock-when>

			<!-- Mock Salesforce Query returning contacts -->
			<munit-tools:mock-when doc:name="Mock SF Query" processor="salesforce:query">
				<munit-tools:then-return>
					<munit-tools:payload value="#[[
						{Id: '003AAA1', FirstName: 'Alice', LastName: 'Johnson', Email: 'alice@test.com', Phone: '555-1111', LastModifiedDate: now()},
						{Id: '003BBB2', FirstName: 'Bob', LastName: 'Williams', Email: 'bob@test.com', Phone: '555-2222', LastModifiedDate: now()}
					]]"/>
				</munit-tools:then-return>
			</munit-tools:mock-when>

			<!-- Mock Database Insert -->
			<munit-tools:mock-when doc:name="Mock DB Insert" processor="db:insert">
				<munit-tools:then-return>
					<munit-tools:payload value="#[{affectedRows: 1}]"/>
				</munit-tools:then-return>
			</munit-tools:mock-when>
		</munit:behavior>

		<munit:execution>
			<!-- Execute fetch all data sub-flow -->
			<flow-ref doc:name="Fetch All Data" name="fetchAllData"/>
			<!-- Execute SF to DB sync sub-flow -->
			<flow-ref doc:name="Sync SF to DB" name="syncSalesforceToDb"/>
		</munit:execution>

		<munit:validation>
			<munit-tools:assert-that doc:name="Assert SF Contacts Fetched" expression="#[sizeOf(vars.sfContacts)]" is="#[MunitTools::equalTo(2)]"/>
			<munit-tools:assert-that doc:name="Assert SF Only Contacts Found" expression="#[sizeOf(vars.sfOnlyContacts)]" is="#[MunitTools::equalTo(2)]"/>
		</munit:validation>
	</munit:test>

	<!-- ============================================== -->
	<!-- Test 2: No SF-Only Records to Sync            -->
	<!-- All SF contacts already exist in DB by email  -->
	<!-- ============================================== -->
	<munit:test name="sf-to-db-no-new-records-test" description="Test when all SF contacts already exist in DB (matched by email)">

		<munit:behavior>
			<!-- Mock Database Select returning existing customers -->
			<munit-tools:mock-when doc:name="Mock DB Select" processor="db:select">
				<munit-tools:then-return>
					<munit-tools:payload value="#[[
						{customer_id: 1, salesforce_id: '003AAA1', first_name: 'Alice', last_name: 'Johnson', email: 'alice@test.com', phone: '555-1111', last_modified_date: now()}
					]]"/>
				</munit-tools:then-return>
			</munit-tools:mock-when>

			<!-- Mock Salesforce Query returning same contact -->
			<munit-tools:mock-when doc:name="Mock SF Query" processor="salesforce:query">
				<munit-tools:then-return>
					<munit-tools:payload value="#[[
						{Id: '003AAA1', FirstName: 'Alice', LastName: 'Johnson', Email: 'alice@test.com', Phone: '555-1111', LastModifiedDate: now()}
					]]"/>
				</munit-tools:then-return>
			</munit-tools:mock-when>
		</munit:behavior>

		<munit:execution>
			<flow-ref doc:name="Fetch All Data" name="fetchAllData"/>
			<flow-ref doc:name="Sync SF to DB" name="syncSalesforceToDb"/>
		</munit:execution>

		<munit:validation>
			<munit-tools:assert-that doc:name="Assert No SF-Only Contacts" expression="#[sizeOf(vars.sfOnlyContacts)]" is="#[MunitTools::equalTo(0)]"/>
		</munit:validation>
	</munit:test>

	<!-- ============================================== -->
	<!-- Test 3: Empty Salesforce - No Contacts        -->
	<!-- ============================================== -->
	<munit:test name="sf-to-db-empty-sf-test" description="Test sync when no contacts in Salesforce">

		<munit:behavior>
			<!-- Mock Database returning customers -->
			<munit-tools:mock-when doc:name="Mock DB Select" processor="db:select">
				<munit-tools:then-return>
					<munit-tools:payload value="#[[
						{customer_id: 1, salesforce_id: null, first_name: 'John', last_name: 'Doe', email: 'john@test.com', phone: '555-0000', last_modified_date: now()}
					]]"/>
				</munit-tools:then-return>
			</munit-tools:mock-when>

			<!-- Mock Salesforce returning empty list -->
			<munit-tools:mock-when doc:name="Mock SF Empty" processor="salesforce:query">
				<munit-tools:then-return>
					<munit-tools:payload value="#[[]]"/>
				</munit-tools:then-return>
			</munit-tools:mock-when>
		</munit:behavior>

		<munit:execution>
			<flow-ref doc:name="Fetch All Data" name="fetchAllData"/>
			<flow-ref doc:name="Sync SF to DB" name="syncSalesforceToDb"/>
		</munit:execution>

		<munit:validation>
			<munit-tools:assert-that doc:name="Assert Zero SF Contacts" expression="#[sizeOf(vars.sfContacts)]" is="#[MunitTools::equalTo(0)]"/>
			<munit-tools:assert-that doc:name="Assert Zero SF-Only" expression="#[sizeOf(vars.sfOnlyContacts)]" is="#[MunitTools::equalTo(0)]"/>
		</munit:validation>
	</munit:test>

	<!-- ============================================== -->
	<!-- Test 4: Salesforce Connection Error           -->
	<!-- ============================================== -->
	<munit:test name="sf-to-db-sf-error-test" description="Test Salesforce connection error handling" expectedErrorType="SALESFORCE:CONNECTIVITY">

		<munit:behavior>
			<!-- Mock Database Select -->
			<munit-tools:mock-when doc:name="Mock DB Select" processor="db:select">
				<munit-tools:then-return>
					<munit-tools:payload value="#[[]]"/>
				</munit-tools:then-return>
			</munit-tools:mock-when>

			<!-- Mock Salesforce throwing connectivity error -->
			<munit-tools:mock-when doc:name="Mock SF Error" processor="salesforce:query">
				<munit-tools:then-return>
					<munit-tools:error typeId="SALESFORCE:CONNECTIVITY"/>
				</munit-tools:then-return>
			</munit-tools:mock-when>
		</munit:behavior>

		<munit:execution>
			<flow-ref doc:name="Fetch All Data" name="fetchAllData"/>
		</munit:execution>
	</munit:test>

	<!-- ============================================== -->
	<!-- Test 5: Database Insert Error                 -->
	<!-- ============================================== -->
	<munit:test name="sf-to-db-db-error-test" description="Test database error handling" expectedErrorType="DB:CONNECTIVITY">

		<munit:behavior>
			<!-- Mock Database Select returning empty -->
			<munit-tools:mock-when doc:name="Mock DB Select" processor="db:select">
				<munit-tools:then-return>
					<munit-tools:payload value="#[[]]"/>
				</munit-tools:then-return>
			</munit-tools:mock-when>

			<!-- Mock successful SF query -->
			<munit-tools:mock-when doc:name="Mock SF Query" processor="salesforce:query">
				<munit-tools:then-return>
					<munit-tools:payload value="#[[{Id: '003XXX', FirstName: 'Test', LastName: 'User', Email: 'test@test.com', Phone: '555-0000', LastModifiedDate: now()}]]"/>
				</munit-tools:then-return>
			</munit-tools:mock-when>

			<!-- Mock Database throwing connectivity error -->
			<munit-tools:mock-when doc:name="Mock DB Error" processor="db:insert">
				<munit-tools:then-return>
					<munit-tools:error typeId="DB:CONNECTIVITY"/>
				</munit-tools:then-return>
			</munit-tools:mock-when>
		</munit:behavior>

		<munit:execution>
			<flow-ref doc:name="Fetch All Data" name="fetchAllData"/>
			<flow-ref doc:name="Sync SF to DB" name="syncSalesforceToDb"/>
		</munit:execution>
	</munit:test>

	<!-- ============================================== -->
	<!-- Test 6: Bidirectional Full Sync Test          -->
	<!-- Tests the complete bidirectional flow         -->
	<!-- ============================================== -->
	<munit:test name="bidirectional-full-sync-test" description="Test complete bidirectional sync flow">

		<munit:behavior>
			<!-- Mock Database Select -->
			<munit-tools:mock-when doc:name="Mock DB Select" processor="db:select">
				<munit-tools:then-return>
					<munit-tools:payload value="#[[
						{customer_id: 1, salesforce_id: null, first_name: 'John', last_name: 'Doe', email: 'john@test.com', phone: '555-1234', last_modified_date: now()}
					]]"/>
				</munit-tools:then-return>
			</munit-tools:mock-when>

			<!-- Mock Salesforce Query -->
			<munit-tools:mock-when doc:name="Mock SF Query" processor="salesforce:query">
				<munit-tools:then-return>
					<munit-tools:payload value="#[[
						{Id: '003NEW', FirstName: 'Alice', LastName: 'Smith', Email: 'alice@test.com', Phone: '555-5678', LastModifiedDate: now()}
					]]"/>
				</munit-tools:then-return>
			</munit-tools:mock-when>

			<!-- Mock Salesforce Upsert -->
			<munit-tools:mock-when doc:name="Mock SF Upsert" processor="salesforce:upsert">
				<munit-tools:then-return>
					<munit-tools:payload value="#[{items: [{id: '003JOHN', successful: true}]}]"/>
				</munit-tools:then-return>
			</munit-tools:mock-when>

			<!-- Mock Database Update -->
			<munit-tools:mock-when doc:name="Mock DB Update" processor="db:update">
				<munit-tools:then-return>
					<munit-tools:payload value="#[{affectedRows: 1}]"/>
				</munit-tools:then-return>
			</munit-tools:mock-when>

			<!-- Mock Database Insert -->
			<munit-tools:mock-when doc:name="Mock DB Insert" processor="db:insert">
				<munit-tools:then-return>
					<munit-tools:payload value="#[{affectedRows: 1}]"/>
				</munit-tools:then-return>
			</munit-tools:mock-when>
		</munit:behavior>

		<munit:execution>
			<!-- Execute complete bidirectional sync -->
			<flow-ref doc:name="Fetch All Data" name="fetchAllData"/>
			<flow-ref doc:name="Sync DB to SF" name="syncDbToSalesforce"/>
			<flow-ref doc:name="Sync SF to DB" name="syncSalesforceToDb"/>
		</munit:execution>

		<munit:validation>
			<!-- Verify both directions processed -->
			<munit-tools:assert-that doc:name="Assert DB Customers" expression="#[sizeOf(vars.dbCustomers)]" is="#[MunitTools::equalTo(1)]"/>
			<munit-tools:assert-that doc:name="Assert SF Contacts" expression="#[sizeOf(vars.sfContacts)]" is="#[MunitTools::equalTo(1)]"/>
			<munit-tools:assert-that doc:name="Assert SF Only Contacts" expression="#[sizeOf(vars.sfOnlyContacts)]" is="#[MunitTools::equalTo(1)]"/>
		</munit:validation>
	</munit:test>

</mule>
